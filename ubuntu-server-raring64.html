<!DOCTYPE html><html lang="en"><head><title>ubuntu-server-raring64</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="ubuntu-server-raring64"><meta name="groc-project-path" content="ubuntu-server-raring64.sh"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">ubuntu-server-raring64.sh</div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="ubuntu-server-1304">Ubuntu Server 13.04</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="prerequisites">Prerequisites</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>These steps assume that you've gone through the process of setting up your
virtual machine and are logged into that machine as root. <strong>Important</strong> you
need to have the guest additions disk mounted.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step-1-basic-packages">Step 1: Basic packages</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="install-chef">Install chef</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chef should be installed as per the <a href="http://www.opscode.com/chef/install/">opscode installation instructions</a>
which utilizes a web installer.</p></div></div><div class="code"><div class="wrapper">curl -L https://www.opscode.com/chef/install.sh | bash</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="install-puppet">Install puppet</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Puppet is installed from the default apt repositories provided in Ubuntu. I'm
not currently using puppet, so if there's a better method please send a pull
request.</p></div></div><div class="code"><div class="wrapper">apt-get install -y puppet puppetmaster</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step-2-virtualbox-additions">Step 2: VirtualBox Additions</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="install-build-dependencies">Install build dependencies</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Build dependencies are installed so that virtualbox and generate the
neccisasary kernel modules.</p></div></div><div class="code"><div class="wrapper">apt-get install linux-headers-<span class="k">$(</span>uname -r<span class="k">)</span> build-essential -y</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="mount-the-guest-additions-cdrom">Mount the guest additions CDROM</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Note that you must have 'inserted' the guest additions ISO using the "Install
Guest Additions ..." menu button before this step.</p></div></div><div class="code"><div class="wrapper">mount /dev/cdrom /media/cdrom</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="run-the-guest-additions-installer">Run the guest additions installer</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>VirtualBox provides an installation script which will build the kernel module
that it requires and install other services required for management of the VM
by the host. <em>Note that 'Installing the Window System drivers' will fail, this
is expected as servers don't have a window system.</em></p></div></div><div class="code"><div class="wrapper">sh /media/cdrom/VBoxLinuxAdditions.run</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="remove-the-build-dependencies">Remove the build dependencies</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Once we've installed the VirtualBox additions we don't need the build
dependencies any more. They should be removed to reduce the size of the
virtual machine.</p></div></div><div class="code"><div class="wrapper">apt-get remove linux-headers-<span class="k">$(</span>uname -r<span class="k">)</span> build-essential -y</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step-3-users-groups-and-sudo">Step 3: Users, Groups and Sudo</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="createtheadmingroup">Create the <code>admin</code> group</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The admin group is used to provide passwordless sudo to vagrant.</p></div></div><div class="code"><div class="wrapper">groupadd admin</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="addvagranttotheadmingroup">Add <code>vagrant</code> to the <code>admin</code> group</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>It is important that the <code>admin</code> group is the only group which <code>vagrant</code> is a
member of. This is to prevent the <code>sudo</code> group from overwriting the
passwordless sudo setup of the <code>admin</code> group. The sudoers file keeps the
settings from the <em>last</em> matching group (sudo) which overwrites the settings
of the admin group.</p></div></div><div class="code"><div class="wrapper">usermod -G admin vagrant</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="configure-sudoers-file">Configure sudoers file</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The <code>admin</code> group needs to be granted access to execute all commands with no
password. Additionally agent forwarding should be kept when vagrant executes
sudo.</p></div></div><div class="code"><div class="wrapper"><span class="nb">echo</span> <span class="s1">&#39;</span>
<span class="s1">Defaults env_keep=&quot;SSH_AUTH_SOCK&quot;</span>
<span class="s1">%admin ALL=NOPASSWD: ALL</span>
<span class="s1">&#39;</span> &gt;&gt; /etc/sudoers</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step-4-ssh-keys">Step 4: SSH Keys</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Vagrant uses an 'insecure' public/private key pair to facilitate conntections
to the VM. This key pair needs to be stored and authorized for connections.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="create-ssh-config-directory">Create SSH config directory</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the <code>/home/vagrant/.ssh</code> directory</p></div></div><div class="code"><div class="wrapper">mkdir /home/vagrant/.ssh</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Change to that directory</p></div></div><div class="code"><div class="wrapper"><span class="nb">cd</span> /home/vagrant/.ssh</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="download-ssh-keys">Download SSH Keys</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Download the <a href="https://github.com/mitchellh/vagrant/blob/master/keys/vagrant.pub"><code>vagrant</code></a> and <a href="https://github.com/mitchellh/vagrant/blob/master/keys/vagrant.pub"><code>vagrant.pub</code></a> keys from github into the
<code>.ssh</code> directory.</p></div></div><div class="code"><div class="wrapper">wget https://raw.github.com/mitchellh/vagrant/master/keys/vagrant
wget https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Append the contents of <code>vagrant.pub</code> to the <code>authorized_keys</code> to authorize
vagrant to login via ssh.</p></div></div><div class="code"><div class="wrapper">cat vagrant.pub &gt;&gt; authorized_keys</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure that the correct permissions are applied to the <code>authorized_keys</code>,
<code>vagrant</code> and <code>vagrant.pub</code> folders</p></div></div><div class="code"><div class="wrapper">chmod 0700 .
chown vagrant:vagrant authorized_keys vagrant vagrant.pub
chmod 0600 authorized_keys vagrant vagrant.pub</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step-5-cleanup">Step 5: Cleanup</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This step is sourced from the <a href="https://gist.github.com/adrienbrault/3775253"><code>purge.sh</code> gist</a> by <a href="https://gist.github.com/adrienbrault">Adrien Brault</a> and
will minimize the size of the created box file.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="remove-unused-packages">Remove unused packages</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">apt-get purge -y ri
apt-get purge -y installation-report landscape-common wireless-tools wpasupplicant ubuntu-serverguide
apt-get purge -y python-dbus libnl1 python-smartpm python-twisted-core libiw30
apt-get purge -y python-twisted-bin libdbus-glib-1-2 python-pexpect python-pycurl python-serial python-gobject python-pam python-openssl</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="remove-apt-cache">Remove APT cache</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">apt-get clean -y
apt-get autoclean -y</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="zero-free-space-to-aid-vm-compression">Zero free space to aid VM compression</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/EMPTY <span class="nv">bs</span><span class="o">=</span>1M
rm -f /EMPTY</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="remove-bash-history">Remove bash history</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nb">unset </span>HISTFILE
rm -f /root/.bash_history
rm -f /home/vagrant/.bash_history</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="cleanup-log-files">Cleanup log files</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">find /var/log -type f | <span class="k">while </span><span class="nb">read </span>f; <span class="k">do </span><span class="nb">echo</span> -ne <span class="s1">&#39;&#39;</span> &gt; <span class="nv">$f</span>; <span class="k">done</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="whiteout-root">Whiteout root</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">count</span><span class="o">=</span><span class="sb">`</span>df --sync -kP / | tail -n1  | awk -F <span class="s1">&#39; &#39;</span> <span class="s1">&#39;{print $4}&#39;</span><span class="sb">`</span>
<span class="nb">let </span>count--
dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/tmp/whitespace <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span><span class="nv">$count</span>
rm /tmp/whitespace
 </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="whiteout-boot">Whiteout /boot</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">count</span><span class="o">=</span><span class="sb">`</span>df --sync -kP /boot | tail -n1 | awk -F <span class="s1">&#39; &#39;</span> <span class="s1">&#39;{print $4}&#39;</span><span class="sb">`</span>
<span class="nb">let </span>count--
dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/boot/whitespace <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span><span class="nv">$count</span>
rm /boot/whitespace
 </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="whiteout-swap">Whiteout swap</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">swappart</span><span class="o">=</span><span class="sb">`</span>cat /proc/swaps | tail -n1 | awk -F <span class="s1">&#39; &#39;</span> <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
swapoff <span class="nv">$swappart</span>
dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="nv">$swappart</span>
mkswap <span class="nv">$swappart</span>
swapon <span class="nv">$swappart</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step-6-reboot">Step 6: Reboot</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>System is should rebooted to give it a final flush out and to restore things
like the history file.</p></div></div><div class="code"><div class="wrapper">reboot</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="thanks-to">Thanks to</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The contents of this script has been compiled from a bunch of different
resources I found around the web. I just wanted to say a big thanks to those
who shared their experiences and knowledge and encourage you to have a look at
their aritcles yourself.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><strong><a href="https://github.com/fespinoza">Felipe Espinoza</a></strong></p>

<blockquote>
  <p><a href="https://github.com/fespinoza/checklist_and_guides/wiki/Creating-a-vagrant-base-box-for-ubuntu-12.04-32bit-server">Creating a vagrant base box for ubuntu 12.04 32bit server</a></p>
</blockquote></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><strong><a href="http://briceno.mx">Basilio Briceño</a></strong></p>

<blockquote>
  <p><a href="http://briceno.mx/2012/10/easy-guide-to-create-a-vagrant-box-from-virtualbox/">Easy and simple guide to create your own Vagrant box (Ubuntu-12.02-64
    server bridged) from VirtualBox</a></p>
</blockquote></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><strong><a href="https://gist.github.com/adrienbrault">Adrien Brault</a></strong></p>

<blockquote>
  <p><a href="https://gist.github.com/adrienbrault/3775253"><code>purge.sh</code></a> - a gist for </p>
</blockquote></div></div></div></div></body></html>